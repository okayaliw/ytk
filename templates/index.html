{% extends 'base.html' %}
{% block title %}Dashboard - Analytica{% endblock %}

{% block content %}
<header class="d-flex justify-content-between align-items-center mb-5">
    <div>
        <h1 class="h2 fw-bold mb-0">Dashboard</h1>
        <p class="text-secondary mb-0">Performance overview for the selected period.</p>
    </div>
    <div class="d-flex align-items-center">
        <div class="btn-group me-3" role="group" id="period-filter">
            <button type="button" class="btn-custom-secondary btn-sm" data-period="1d">1D</button>
            <button type="button" class="btn-custom-secondary btn-sm" data-period="7d">7D</button>
            <button type="button" class="btn-custom-secondary btn-sm" data-period="90d">90D</button>
            <button type="button" class="btn-custom-secondary btn-sm active" data-period="30d">30D</button>
            <button type="button" class="btn-custom-secondary btn-sm" data-period="365d">1Y</button>
            <button type="button" class="btn-custom-secondary btn-sm" data-period="all">All</button>
        </div>
        <button class="btn-custom-primary" data-bs-toggle="modal" data-bs-target="#addChannelModal"><i class="bi bi-plus-lg me-1"></i> Add Channel</button>
    </div>
</header>
<div id="dashboard-error-container"></div>
<div id="dashboard-body" style="opacity:0; transition: opacity 0.5s ease;">
    <div class="row g-4 mb-4" id="summary-cards"></div>
    <div class="row g-4 mb-5">
        <div class="col-lg-6"><div class="custom-card h-100"><div class="card-body p-4"><h5 class="fw-semibold">Subscriber Growth</h5><div style="height: 300px;"><canvas id="subsChart"></canvas></div></div></div></div>
        <div class="col-lg-6"><div class="custom-card h-100"><div class="card-body p-4"><h5 class="fw-semibold">Views Growth</h5><div style="height: 300px;"><canvas id="viewsChart"></canvas></div></div></div></div>
    </div>
    <div class="row g-4 mb-5">
        <div class="col-lg-12"><div class="custom-card h-100"><div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-semibold mb-0">Top Performers</h5>
                <div class="btn-group" role="group" id="top-performers-filter">
                    <button type="button" class="btn-custom-secondary btn-sm active" data-metric="subs">By Subscribers</button>
                    <button type="button" class="btn-custom-secondary btn-sm" data-metric="views">By Views</button>
                </div>
            </div>
            <div id="top-performers-list"></div>
        </div></div></div>
    </div>
    <div class="custom-card">
        <div class="card-header bg-transparent border-bottom-0 p-4"><h5 class="fw-semibold mb-0">All Channels Detailed Stats</h5></div>
        <div class="table-responsive"><table class="table align-middle mb-0"><thead id="channel-table-header"></thead><tbody id="channel-table-body"></tbody></table></div>
    </div>
</div>

<div class="modal fade" id="addChannelModal" tabindex="-1"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title">Add Channel</h5> <button type="button" class="btn-close" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="addChannelForm"> <div class="mb-3"> <label for="channelQueryInput" class="form-label">Channel URL, ID, or Name</label> <input type="text" class="form-control" id="channelQueryInput" required> </div> <div id="form-error" class="alert alert-danger d-none"></div> </form> </div> <div class="modal-footer"> <button type="button" class="btn-custom-secondary" data-bs-dismiss="modal">Cancel</button> <button type="submit" class="btn-custom-primary" form="addChannelForm" id="addChannelSubmitButton">Add Channel</button> </div> </div> </div> </div>
<div class="modal fade" id="editChannelModal" tabindex="-1"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="editModalTitle">Edit Channel</h5> <button type="button" class="btn-close" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="editChannelForm"> <input type="hidden" id="editChannelId"> <div class="mb-3"> <label for="editNickname" class="form-label">Custom Name (for Category Mode)</label> <input type="text" class="form-control" id="editNickname" placeholder="e.g., Gaming Guru"> </div> <div class="mb-3"> <label for="editCategory" class="form-label">Category</label> <select class="form-select" id="editCategory"> <option>Default</option><option>Gaming</option><option>Tech</option><option>Music</option><option>Vlog</option><option>Education</option> </select> </div> </form> </div> <div class="modal-footer"> <button type="button" class="btn-custom-secondary" data-bs-dismiss="modal">Cancel</button> <button type="submit" class="btn-custom-primary" form="editChannelForm" id="editChannelSubmitButton">Save</button> </div> </div> </div> </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPeriod = '30d';
    let topPerformersMetric = 'subs';
    let dashboardData = null;
    let subsChart = null, viewsChart = null;
    const addModal = new bootstrap.Modal(document.getElementById('addChannelModal'));
    const editModal = new bootstrap.Modal(document.getElementById('editChannelModal'));

    const renderTopPerformers = () => {
        if (!dashboardData) return;
        const periodKey = document.querySelector('#period-filter .active').dataset.period;
        const metricKey = topPerformersMetric === 'subs' ? `subs_change_${periodKey}` : `views_change_${periodKey}`;
        if (periodKey === 'all') { // "All Time" için bir mantık
             document.getElementById('top-performers-list').innerHTML = `<p class="text-secondary small">"All Time" does not support top performers sorting.</p>`;
             return;
        }
        const sorted = [...dashboardData.channels].sort((a, b) => (b[metricKey] || 0) - (a[metricKey] || 0));
        
        document.getElementById('top-performers-list').innerHTML = sorted.slice(0, 5).map(ch => `
            <div class="d-flex align-items-center mb-3">
                <a href="/channel/${ch.id}" class="real-image text-decoration-none"><img src="${ch.image_url}" width="40" height="40" class="rounded-circle me-3 name-and-image"></a>
                <a href="/channel/${ch.id}" class="category-image text-decoration-none"><div class="category-avatar category-${(ch.category || 'default').toLowerCase()} me-3">${(ch.nickname || ch.name).charAt(0)}</div></a>
                <div class="flex-grow-1">
                    <a href="/channel/${ch.id}" class="fw-semibold text-decoration-none text-white"><span class="real-name name-and-image">${ch.name}</span><span class="category-name">${ch.nickname || ch.name}</span></a>
                    <div class="small text-secondary"><span class="real-name name-and-image">${formatNumber(ch.subscribers)} subs</span><span class="category-name">${ch.category || 'N/A'}</span></div>
                </div>
                <div class="fw-semibold text-success">+${formatNumber(ch[metricKey])}</div>
            </div>`).join('') || `<p class="text-secondary small">No significant changes in this period.</p>`;
    };

    const renderUI = (data) => {
        dashboardData = data;
        const { summary, chart_data, channels } = data;
        const periodText = document.querySelector(`#period-filter .active`).textContent;
        document.getElementById('summary-cards').innerHTML = summary.map(item => `<div class="col-md-6 col-lg-3"><div class="custom-card"><div class="card-body p-3"><h6 class="text-secondary fw-normal mb-1">${item.title}</h6><h4 class="h3 fw-bold mb-1">${item.value}</h4><small class="${item.isPositive ? 'text-success' : 'text-danger'}">${item.change} in ${periodText}</small></div></div></div>`).join('');
        
        subsChart = createChart('subsChart', subsChart, chart_data.labels, chart_data.subscribers, '0, 122, 255', 'Subscribers');
        viewsChart = createChart('viewsChart', viewsChart, chart_data.labels, chart_data.views, '52, 199, 89', 'Views');
        
        renderTopPerformers();
        
        document.getElementById('channel-table-header').innerHTML = `<tr><th class="ps-4">Channel</th><th>1D</th><th>7D</th><th>30D</th><th>1Y</th><th class="text-end pe-4">Actions</th></tr>`;
        document.getElementById('channel-table-body').innerHTML = channels.map(ch => {
            const renderChange = (subs, views) => `<div class="d-flex flex-column">${subs != 'N/A' ? `<small class="${subs >= 0 ? 'text-success' : 'text-danger'}">${subs >= 0 ? '+' : ''}${formatNumber(subs)}</small>` : ''}${views != 'N/A' ? `<small class="${views >= 0 ? 'text-success' : 'text-danger'}">${views >= 0 ? '+' : ''}${formatNumber(views)}</small>` : ''}</div>`;
            return `<tr>
                <td class="ps-4"><div class="d-flex align-items-center">
                    <a href="/channel/${ch.id}" class="real-image text-decoration-none"><img src="${ch.image_url}" width="40" height="40" class="rounded-circle me-3 name-and-image"></a>
                    <a href="/channel/${ch.id}" class="category-image text-decoration-none"><div class="category-avatar category-${(ch.category || 'default').toLowerCase()} me-3">${(ch.nickname || ch.name).charAt(0)}</div></a>
                    <div>
                        <a href="/channel/${ch.id}" class="fw-semibold text-decoration-none text-white"><span class="real-name name-and-image">${ch.name}</span><span class="category-name">${ch.nickname || ch.name}</span></a>
                        <div class="small text-secondary"><span class="real-name name-and-image">${formatNumber(ch.subscribers)} subs</span><span class="category-name">${ch.category || 'No Category'}</span></div>
                    </div>
                </div></td>
                <td>${renderChange(ch.subs_change_1d, ch.views_change_1d)}</td>
                <td>${renderChange(ch.subs_change_7d, ch.views_change_7d)}</td>
                <td>${renderChange(ch.subs_change_30d, ch.views_change_30d)}</td>
                <td>${renderChange(ch.subs_change_365d, ch.views_change_365d)}</td>
                <td class="text-end pe-4"><div class="dropdown">
                    <button class="btn btn-custom-ghost btn-sm" type="button" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="openEditModal(event, ${ch.id})">Edit</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteChannel(event, ${ch.id}, '${ch.name.replace(/'/g, "\\'")}')">Delete</a></li>
                    </ul>
                </div></td>
            </tr>`
        }).join('');
    };

    const fetchData = async () => {
        document.getElementById('dashboard-body').style.opacity = '0.5';
        try {
            const response = await fetch(`/api/dashboard_data?period=${currentPeriod}`);
            if (!response.ok) { const err = await response.json(); throw new Error(err.error || 'API request failed.'); }
            const data = await response.json();
            if (data.error) throw new Error(data.error);
            renderUI(data);
            document.getElementById('dashboard-error-container').innerHTML = '';
        } catch (error) {
            document.getElementById('dashboard-error-container').innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
        } finally {
            document.getElementById('dashboard-body').style.opacity = '1';
        }
    };

    document.getElementById('period-filter').addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON' && !e.target.classList.contains('active')) {
            document.querySelector('#period-filter .active')?.classList.remove('active');
            e.target.classList.add('active');
            currentPeriod = e.target.dataset.period;
            fetchData();
        }
    });

    document.getElementById('top-performers-filter').addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON' && !e.target.classList.contains('active')) {
            document.querySelector('#top-performers-filter .active')?.classList.remove('active');
            e.target.classList.add('active');
            topPerformersMetric = e.target.dataset.metric;
            renderTopPerformers();
        }
    });

    document.getElementById('addChannelForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const query = document.getElementById('channelQueryInput').value;
        const errorDiv = document.getElementById('form-error');
        errorDiv.classList.add('d-none');
        try {
            const res = await fetch('/api/channels', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({channel_query: query})});
            if (!res.ok) { const err = await res.json(); throw new Error(err.error); }
            addModal.hide();
            e.target.reset();
            fetchData();
        } catch(err) { errorDiv.textContent = err.message; errorDiv.classList.remove('d-none'); }
    });

    window.openEditModal = async (e, channelId) => {
        e.preventDefault();
        try {
            const res = await fetch(`/api/channel/${channelId}`);
            if (!res.ok) throw new Error('Could not fetch channel details.');
            const channel = await res.json();
            document.getElementById('editChannelId').value = channel.id;
            document.getElementById('editModalTitle').textContent = `Edit ${channel.name}`;
            document.getElementById('editNickname').value = channel.nickname || '';
            document.getElementById('editCategory').value = channel.category || 'Default';
            editModal.show();
        } catch (err) { alert(err.message); }
    };

    document.getElementById('editChannelForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('editChannelId').value;
        const nickname = document.getElementById('editNickname').value;
        const category = document.getElementById('editCategory').value;
        try {
            const res = await fetch(`/api/channels/${id}/update`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({nickname, category})});
            if (!res.ok) throw new Error('Update failed.');
            editModal.hide();
            fetchData();
        } catch(err) { alert(err.message); }
    });
    
    window.deleteChannel = async (e, id, name) => {
        e.preventDefault();
        if (confirm(`Are you sure you want to delete '${name}'?`)) {
            await fetch(`/api/channels/${id}`, { method: 'DELETE' });
            fetchData();
        }
    };

    fetchData();
});
</script>
{% endblock %}